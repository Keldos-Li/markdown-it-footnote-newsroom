/*! markdown-it-footnote-newsroom 4.0.2 https://github.com/Keldos-Li/markdown-it-footnote-newsroom @license MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).markdownitFootnoteNewsroom=t()}(this,function(){"use strict";function e(e,t,n,o){const s=Number(e[t].meta.id+1).toString();let r="";return"string"==typeof o.docId&&(r=`-${o.docId}-`),r+s}function t(e,t){return Number(e[t].meta.id+1).toString()}function n(e,t,n,o,s){const r=s.rules.footnote_anchor_name(e,t,n,o,s),f=s.rules.footnote_caption(e,t,n,o,s);let c=r;return e[t].meta.subId>0&&(c+=`:${e[t].meta.subId}`),`<sup class="footnote-ref"><a href="#fn${r}" id="fnref${c}">${f}</a></sup>`}function o(e,t,n){return'<div class="sosumi footnotes component text"><div class="component-content">\n<p></p>\n<ol class="footnotes-list">\n'}function s(){return"</ol>\n</div></div>\n"}function r(e,t,n,o,s){let r=s.rules.footnote_anchor_name(e,t,n,o,s);return e[t].meta.subId>0&&(r+=`:${e[t].meta.subId}`),`<li id="fn${r}" class="footnote-item">`}function f(){return"</li>\n"}function c(e,t,n,o,s){let r=s.rules.footnote_anchor_name(e,t,n,o,s);return e[t].meta.subId>0&&(r+=`:${e[t].meta.subId}`),` <a href="#fnref${r}" class="footnote-backref">\u21a9\ufe0e</a>`}return function(l){const i=l.helpers.parseLinkLabel,u=l.utils.isSpace;l.renderer.rules.footnote_ref=n,l.renderer.rules.footnote_block_open=o,l.renderer.rules.footnote_block_close=s,l.renderer.rules.footnote_open=r,l.renderer.rules.footnote_close=f,l.renderer.rules.footnote_anchor=c,l.renderer.rules.footnote_caption=t,l.renderer.rules.footnote_anchor_name=e,l.block.ruler.before("reference","footnote_def",function(e,t,n,o){const s=e.bMarks[t]+e.tShift[t],r=e.eMarks[t];if(s+4>r)return!1;if(91!==e.src.charCodeAt(s))return!1;if(94!==e.src.charCodeAt(s+1))return!1;let f;for(f=s+2;f<r;f++){if(32===e.src.charCodeAt(f))return!1;if(93===e.src.charCodeAt(f))break}if(f===s+2)return!1;if(f+1>=r||58!==e.src.charCodeAt(++f))return!1;if(o)return!0;f++,e.env.footnotes||(e.env.footnotes={}),e.env.footnotes.refs||(e.env.footnotes.refs={});const c=e.src.slice(s+2,f-2);e.env.footnotes.refs[`:${c}`]=-1;const l=new e.Token("footnote_reference_open","",1);l.meta={label:c},l.level=e.level++,e.tokens.push(l);const i=e.bMarks[t],a=e.tShift[t],p=e.sCount[t],h=e.parentType,d=f,k=e.sCount[t]+f-(e.bMarks[t]+e.tShift[t]);let _=k;for(;f<r;){const t=e.src.charCodeAt(f);if(!u(t))break;9===t?_+=4-_%4:_++,f++}e.tShift[t]=f-d,e.sCount[t]=_-k,e.bMarks[t]=d,e.blkIndent+=4,e.parentType="footnote",e.sCount[t]<e.blkIndent&&(e.sCount[t]+=e.blkIndent),e.md.block.tokenize(e,t,n,!0),e.parentType=h,e.blkIndent-=4,e.tShift[t]=a,e.sCount[t]=p,e.bMarks[t]=i;const b=new e.Token("footnote_reference_close","",-1);return b.level=--e.level,e.tokens.push(b),!0},{alt:["paragraph","reference"]}),l.inline.ruler.after("image","footnote_inline",function(e,t){const n=e.posMax,o=e.pos;if(o+2>=n)return!1;if(94!==e.src.charCodeAt(o))return!1;if(91!==e.src.charCodeAt(o+1))return!1;const s=o+2,r=i(e,o+1);if(r<0)return!1;if(!t){e.env.footnotes||(e.env.footnotes={}),e.env.footnotes.list||(e.env.footnotes.list=[]);const t=e.env.footnotes.list.length,n=[];e.md.inline.parse(e.src.slice(s,r),e.md,e.env,n);e.push("footnote_ref","",0).meta={id:t},e.env.footnotes.list[t]={content:e.src.slice(s,r),tokens:n}}return e.pos=r+1,e.posMax=n,!0}),l.inline.ruler.after("footnote_inline","footnote_ref",function(e,t){const n=e.posMax,o=e.pos;if(o+3>n)return!1;if(!e.env.footnotes||!e.env.footnotes.refs)return!1;if(91!==e.src.charCodeAt(o))return!1;if(94!==e.src.charCodeAt(o+1))return!1;let s;for(s=o+2;s<n;s++){if(32===e.src.charCodeAt(s))return!1;if(10===e.src.charCodeAt(s))return!1;if(93===e.src.charCodeAt(s))break}if(s===o+2)return!1;if(s>=n)return!1;s++;const r=e.src.slice(o+2,s-1);if(void 0===e.env.footnotes.refs[`:${r}`])return!1;if(!t){let t;e.env.footnotes.list||(e.env.footnotes.list=[]),e.env.footnotes.refs[`:${r}`]<0?(t=e.env.footnotes.list.length,e.env.footnotes.list[t]={label:r,count:0},e.env.footnotes.refs[`:${r}`]=t):t=e.env.footnotes.refs[`:${r}`];const n=e.env.footnotes.list[t].count;e.env.footnotes.list[t].count++;e.push("footnote_ref","",0).meta={id:t,subId:n,label:r}}return e.pos=s,e.posMax=n,!0}),l.core.ruler.after("inline","footnote_tail",function(e){let t,n,o,s=!1;const r={};if(!e.env.footnotes)return;if(e.tokens=e.tokens.filter(function(e){return"footnote_reference_open"===e.type?(s=!0,n=[],o=e.meta.label,!1):"footnote_reference_close"===e.type?(s=!1,r[":"+o]=n,!1):(s&&n.push(e),!s)}),!e.env.footnotes.list)return;const f=e.env.footnotes.list;e.tokens.push(new e.Token("footnote_block_open","",1));for(let n=0,o=f.length;n<o;n++){const o=new e.Token("footnote_open","",1);if(o.meta={id:n,label:f[n].label},e.tokens.push(o),f[n].tokens){t=[];const o=new e.Token("paragraph_open","p",1);o.block=!0,t.push(o);const s=new e.Token("inline","",0);s.children=f[n].tokens,s.content=f[n].content,t.push(s);const r=new e.Token("paragraph_close","p",-1);r.block=!0,t.push(r)}else f[n].label&&(t=r[`:${f[n].label}`]);let s;t&&(e.tokens=e.tokens.concat(t)),s="paragraph_close"===e.tokens[e.tokens.length-1].type?e.tokens.pop():null;const c=f[n].count>0?f[n].count:1;for(let t=0;t<c;t++){const o=new e.Token("footnote_anchor","",0);o.meta={id:n,subId:t,label:f[n].label},e.tokens.push(o)}s&&e.tokens.push(s),e.tokens.push(new e.Token("footnote_close","",-1))}e.tokens.push(new e.Token("footnote_block_close","",-1))}),l.core.ruler.after("footnote_tail","footnote_wrap_context",function(e){const t=/^[\uff0c\u3001\u3002\uff01\uff1f\uff1b\uff1a\u300d\u300b\u201d\u2019\uff09\u3011\u3015\u2026\xb7\u2014\uff5e,.!?;:]/;for(let n=0;n<e.tokens.length;n++){const o=e.tokens[n];if("inline"!==o.type||!o.children)continue;const s=o.children,r=[];for(let n=0;n<s.length;n++)if("footnote_ref"===s[n].type){let o=r.length,f=!1;if(o>0){let n="",s=[];for(let e=o-1;e>=0&&"text"===r[e].type;e--)s.unshift(e),n=r[e].content+n;if(s.length>0){let c=n.length;for(;c>0&&/\s/.test(n[c-1]);)c--;for(;c>0&&t.test(n[c-1]);)c--;for(;c>0&&/\s/.test(n[c-1]);)c--;let l=n.slice(0,c),i=l.match(/[a-zA-Z0-9]+$/),u=-1;if(i?u=i.index:(i=l.match(/[\u4E00-\u9FFF]$/),i&&(u=i.index)),-1!==u){let t=0;for(let n of s){const s=r[n].content.length;if(u>=t&&u<t+s){const s=u-t,c=r[n].content.slice(0,s),l=r[n].content.slice(s);c?r[n].content=c:(r.splice(n,1),o--);let i=l;const a=c?n+1:n;for(let e=a;e<o;e++)"text"===r[e].type&&(i+=r[e].content);for(let e=a;e<o;e++)"text"===r[e].type&&(r.splice(e,1),o--,e--);const p=new e.Token("html_inline","",0);p.content='<span class="nowrap">',r.push(p);const h=new e.Token("text","",0);h.content=i,r.push(h),f=!0;break}t+=s}}}}if(!f){const t=new e.Token("html_inline","",0);t.content='<span class="nowrap">',r.push(t)}r.push(s[n]);let c=!1;if(n+1<s.length&&"text"===s[n+1].type){const o=s[n+1].content,f=o.match(t);if(f){const t=f[0],s=o.slice(t.length),l=new e.Token("text","",0);l.content=t,r.push(l);const i=new e.Token("html_inline","",0);if(i.content="</span>",r.push(i),s){const t=new e.Token("text","",0);t.content=s,r.push(t)}n++,c=!0}}if(!c){const t=new e.Token("html_inline","",0);t.content="</span>",r.push(t)}}else r.push(s[n]);o.children=r}})}});
